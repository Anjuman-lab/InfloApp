@page "/logs"
@inject IActivityLogService ActivityLogService

<h2 class="fw-bold mb-1">Activity Logs</h2>
<p class="text-muted mb-4">Track all actions performed across the application</p>

<!-- FILTER BAR -->
<div class="card shadow-sm border-0 mb-4 p-3">
    <div class="row g-3 align-items-end">
        <div class="col-md-4">
            <label class="form-label small text-muted">Search logs</label>
            <input class="form-control"
                   placeholder="Search logs..."
                   @bind="searchTerm"
                   @oninput="() => OnFiltersChanged()" />
        </div>

        <div class="col-md-2">
            <label class="form-label small text-muted">Start date</label>
            <input type="date" class="form-control" @bind="startDate"  @bind:after="OnFiltersChanged" />
        </div>

        <div class="col-md-2">
            <label class="form-label small text-muted">End date</label>
            <input type="date" class="form-control" @bind="endDate" @bind:after="OnFiltersChanged" />
        </div>

        <div class="col-md-2">
            <label class="form-label small text-muted">Filter by User ID</label>
            <input class="form-control"
                   @bind="userIdFilterText"
                   @oninput="() => OnFiltersChanged()" />
        </div>

        <div class="col-md-2">
            <label class="form-label small text-muted">Action</label>
            <select class="form-select"
                    @bind="actionFilter"
                    @bind:after="OnFiltersChanged">
                <option value="All">All Actions</option>
                <option value="User Created">User Created</option>
                <option value="User Updated">User Updated</option>
                <option value="User Deleted">User Deleted</option>
            </select>
        </div>
    </div>
</div>

<!-- SUMMARY CARDS -->
<div class="row g-3 mb-3">
    <div class="col-md-4">
        <div class="card shadow-sm border-0 p-3">
            <div class="text-muted small">Total Logs</div>
            <div class="fs-4 fw-bold">@totalLogs</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm border-0 p-3">
            <div class="text-muted small">Filtered Results</div>
            <div class="fs-4 fw-bold">@filteredCount</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm border-0 p-3">
            <div class="text-muted small">Total Pages</div>
            <div class="fs-4 fw-bold">@totalPages</div>
        </div>
    </div>
</div>

<!-- LOGS TABLE -->
<div class="card shadow-sm border-0">
    <div class="table-responsive">
        <table class="table align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Timestamp</th>
                    <th>Action</th>
                    <th>User</th>
                    <th>Performed By</th>
                    <th>Details</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
            @if (currentPageItems.Any())
            {
                @foreach (var log in currentPageItems)
                {
                    <tr>
                        <td class="small text-nowrap">
                            @log.Timestamp.ToLocalTime().ToString("MMM dd, yyyy HH:mm:ss")
                        </td>
                        <td>
                            <span class="badge rounded-pill bg-light text-danger border border-danger">
                                @log.Action
                            </span>
                        </td>
                        <td>@log.UserName</td>
                        <td>@log.PerformedBy</td>
                        <td class="text-truncate" style="max-width: 260px;">@log.Details</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-secondary"
                                    title="View details"
                                    @onclick="() => OpenDetails(log)">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        No logs found
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>

    <!-- PAGINATION -->
    @if (totalPages > 1)
    {
        <div class="card-footer bg-white d-flex justify-content-between align-items-center">
            <span class="small text-muted">
                Page @currentPage of @totalPages
            </span>
            <nav>
                <ul class="pagination mb-0">
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">Previous</button>
                    </li>
                    @for (int p = 1; p <= totalPages; p++)
                    {
                        <li class="page-item @(p == currentPage ? "active" : "")">
                            <button class="page-link" @onclick="() => ChangePage(p)">@p</button>
                        </li>
                    }
                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">Next</button>
                    </li>
                </ul>
            </nav>
        </div>
    }
</div>

<!-- DETAILS MODAL -->
@if (showDetails && selectedLog is not null)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Log Details</h5>
                    <button type="button" class="btn-close" @onclick="CloseDetails"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-2">Complete information about this log entry</p>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="small text-muted">Timestamp</div>
                            <div>@selectedLog.Timestamp.ToLocalTime().ToString("MMMM dd, yyyy 'at' HH:mm:ss")</div>
                        </div>
                        <div class="col-md-6">
                            <div class="small text-muted">Action Type</div>
                            <span class="badge rounded-pill bg-light text-danger border border-danger">
                                @selectedLog.Action
                            </span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="small text-muted">User Affected</div>
                            <div>@selectedLog.UserName</div>
                        </div>
                        <div class="col-md-6">
                            <div class="small text-muted">Performed By</div>
                            <div>@selectedLog.PerformedBy</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="small text-muted">Details</div>
                        <div class="border rounded p-2 bg-light">
                            @selectedLog.Details
                        </div>
                    </div>

                    <div class="small text-muted">
                        Log ID<br />
                        <span class="font-monospace">@selectedLog.Id</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseDetails">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<ActivityLog> allLogs = new();
    private List<ActivityLog> filteredLogs = new();

    private string? searchTerm;
    private DateTime? startDate;
    private DateTime? endDate;
    private string userIdFilterText = string.Empty;
    private string actionFilter = "All";

    private int totalLogs;
    private int filteredCount;
    private int totalPages;
    private int currentPage = 1;
    private const int pageSize = 10;

    private bool showDetails;
    private ActivityLog? selectedLog;

    private IEnumerable<ActivityLog> currentPageItems =>
        filteredLogs
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize);

    protected override async Task OnInitializedAsync()
    {
        allLogs = await ActivityLogService.GetAllAsync();
        totalLogs = allLogs.Count;
        ApplyFilters();
    }

    private void OnFiltersChanged()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        IEnumerable<ActivityLog> query = allLogs;

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var term = searchTerm.ToLowerInvariant();
            query = query.Where(l =>
                (l.Action != null && l.Action.ToLower().Contains(term)) ||
                (l.UserName != null && l.UserName.ToLower().Contains(term)) ||
                (l.PerformedBy != null && l.PerformedBy.ToLower().Contains(term)) ||
                (l.Details != null && l.Details.ToLower().Contains(term)));
        }

        if (startDate.HasValue)
        {
            query = query.Where(l => l.Timestamp >= startDate.Value.Date);
        }

        if (endDate.HasValue)
        {
            var inclusiveEnd = endDate.Value.Date.AddDays(1);
            query = query.Where(l => l.Timestamp < inclusiveEnd);
        }

        if (long.TryParse(userIdFilterText, out var uid))
        {
            query = query.Where(l => l.UserId == uid);
        }

        if (actionFilter != "All")
        {
            query = query.Where(l => l.Action == actionFilter);
        }

        filteredLogs = query
            .OrderByDescending(l => l.Timestamp)
            .ToList();

        filteredCount = filteredLogs.Count;
        totalPages = filteredCount == 0
            ? 0
            : (int)Math.Ceiling(filteredCount / (double)pageSize);

        currentPage = totalPages == 0 ? 0 : 1;
    }

    private void ChangePage(int page)
    {
        if (page < 1 || page > totalPages)
            return;

        currentPage = page;
    }

    private void OpenDetails(ActivityLog log)
    {
        selectedLog = log;
        showDetails = true;
    }

    private void CloseDetails()
    {
        showDetails = false;
        selectedLog = null;
    }
}
